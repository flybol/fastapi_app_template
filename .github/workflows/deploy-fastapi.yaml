name: deploy_fastapi

on:
  push:
    branches:
      - master        # 根据你实际使用的分支修改
      - fastapi
  workflow_dispatch:  # 手动触发也可以

env:
  PYTHON_VERSION: "3.10"
  SERVICE_NAME: "fastapi-app-template"   # ← 这里改成你的 systemd 服务名（xxx.service 去掉 .service）

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取代码（只是为了在 CI 里有代码，可选）
      - name: Checkout repo
        uses: actions/checkout@v5

      # 2. 安装 Python（方便后面如果你想在 CI 里跑测试）
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. 配置 SSH（用你存到 Secrets 里的私钥）
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # 避免首次连接 host key 提示
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      # 4. 部署到服务器：git pull + uv sync + 重启 systemd 服务
      - name: Deploy to server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_TARGET_DIR: ${{ secrets.SSH_TARGET_DIR }}
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
        run: |
          ssh "$SSH_USER@$SSH_HOST" "
            set -e

            echo '===> 切到项目目录: $SSH_TARGET_DIR'
            cd \"$SSH_TARGET_DIR\"

            echo '===> 拉取最新代码'
            git pull

            echo '===> 使用 uv 同步依赖（生产环境）'
            uv sync --frozen --no-dev

            echo '===> 重载 systemd 配置并重启服务: $SERVICE_NAME'
            sudo systemctl daemon-reload
            sudo systemctl restart \"$SERVICE_NAME\"

            echo '===> 查看服务状态'
            sudo systemctl --no-pager -l status \"$SERVICE_NAME\" || true
          "
